/*!
 * auhtor: Luis Eduardo Miranda Barja
 * (C) 2015 - mbarjaedu13@gmail.com
 */
$(function(){$(".manager-menu, .user-sub").addClass("active");$("#cancel, .back").on({click:function(k){k.preventDefault();location.href="/usuarios/gestion";}});var e=$("#inputRol"),j=e.closest(".form-group").next(),f=$(".redes_salud"),h=$(".municipios"),a=$(".centros_salud"),c=function(k){var l=[$("<option/>",{value:-1,text:"-- Elija Una --"})];for(var m=0;m<k.length;m++){var n=k[m],o=$("<option/>",{value:n.id_red,text:n.nombre}).data({municipios:n.municipios,centros:n.centros});l.push(o);}return l.length>1?l:[$("<option/>",{value:-1,text:"-- Sin Redes de Salud --"})];},g=function(n){var l=[$("<option/>",{value:-1,text:"-- Elija Uno --"})];for(var m=0;m<n.length;m++){var k=n[m],o=$("<option/>",{value:k.id_mup,text:k.nombre});l.push(o);}return l.length>1?l:[$("<option/>",{value:-1,text:"-- Sin Municipios --"})];},b=function(l){var m=[$("<option/>",{value:-1,text:"-- Elija Uno --"})];for(var n=0;n<l.length;n++){var k=l[n],o=$("<option/>",{value:k.id_cen,text:k.nombre});m.push(o);}return m.length>1?m:[$("<option/>",{value:-1,text:"-- Sin Establecimientos --"})];};j.disable().hide();f.disable().hide();h.disable().hide();a.disable().hide();$.post("/redes_salud/disponibles",data={_xsrf:getCookie("_xsrf")},function(k){if($.type(k)=="array"){f.find("select").html(c(k));}});$("#inputLogin").on({blur:function(m){var l=$(this).val(),k=$(this);if(l.length>5){$.post("/usuarios/v_login",data={_xsrf:getCookie("_xsrf"),login:l},function(n){if(n){$("button[type=submit]").disable();k.val("").focus().closest(".form-group").removeClass("has-success").addClass("has-error").find("span").removeClass("fa-check").addClass("fa fa-time");swal({title:"Error!",text:'"'+l+'", no está disponible!.\nPor favor elija otro.',type:"error",confirmButtonText:"Continuar",closeOnConfirm:false});}else{$("button[type=submit]").enable();k.closest(".form-group").removeClass("has-error fail-check").addClass("has-success").find("span").removeClass("fa-times").addClass("fa fa-check");}});}}});$("#inputTelf").on({blur:function(l){var k=$(this).val(),m=$(this);if(k.length==8){$.post("/personas/v_userstelf",data={_xsrf:getCookie("_xsrf"),telf:k},function(n){$("form").find(".optional").each(function(){$(this).enable().show();});if(n==null){m.val("").focus().closest(".form-group").removeClass("has-success").addClass("has-error").find("span").removeClass("fa-check").addClass("fa fa-time");swal({title:"Error!",text:"El nro. "+k+", está registrado!.\nPor favor use otro.",type:"error",confirmButtonText:"Continuar",closeOnConfirm:false});}else{if(n==true){m.closest(".form-group").removeClass("has-error").addClass("has-success").find("span").removeClass("fa-times").addClass("fa fa-check");$.post("/personas/getbycellphone",data={_xsrf:getCookie("_xsrf"),telf:k},function(o){$("form").find(".person").text(o.persona).end().find(".optional").each(function(){$(this).disable().hide();});});}else{m.closest(".form-group").removeClass("has-error").addClass("has-success").find("span").removeClass("fa-times").addClass("fa fa-check");}}});}else{if(k.length>0&&k.length<8){m.focus().val("");}else{if(k.length==0){m.focus().val("");}}}}});$("input[name=ci]").on({blur:function(m){var l=$(this),k=$(this).val();if(k.length>=7&&k.length<=8){$.post("/personas/v_ci",data={_xsrf:getCookie("_xsrf"),ci:l.val()},function(n){if(n){l.val("").focus().closest(".form-group").removeClass("has-success").addClass("has-error").find("span").removeClass("fa-check").addClass("fa fa-time");swal({title:"Error!",text:"El CI: "+k+", está registrado!.\nPor favor use otro.",type:"error",confirmButtonText:"Continuar",closeOnConfirm:false});}else{l.closest(".form-group").removeClass("has-error").addClass("has-success").find("span").removeClass("fa-times").addClass("fa fa-check");}});}}});e.on({change:function(k){if($(this).val()=="Operador de Registro"){j.enable().show();}else{j.find('option[value="1"]').attr("selected",true).end().disable().hide();f.find("select").find('option[value="-1"]').attr("selected",true).end().end().disable().hide();h.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide();a.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide();}}});j.find("select").on({change:function(l){var k=+$(this).val();f.find("select").find('option[value="-1"]').attr("selected",true).end().end().disable().hide();h.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide();a.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide();if(k==2){f.enable().show();}else{if(k==3){f.enable().show();h.enable().show();}else{if(k==4){f.enable().show();a.enable().show();}}}}});f.find("select").on({change:function(m){var l=+$(this).val(),n=+j.find("select").val(),k=$(this).find("option:selected");h.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide();a.find("select").html('<option value="-1">-- Elija Uno --</option>').end().disable().hide();if(l!=-1&&n==3){h.find("select").html(g(k.data("municipios"))).end().enable().show();}else{if(l!=-1&&n==4){a.find("select").html(b(k.data("centros"))).end().enable().show();}}}});var d=$("form"),i=$("button[type=submit]");d.on({submit:function(k){k.preventDefault();k.stopPropagation();i.disable().hide();$.post("/usuarios/nuevo_usuario",data=d.form2Dict(),function(l){if(l){location.href="/usuarios/gestion";}else{i.enable().show();}});}});});