{% extends "../base.html" %}
{% block header_section %}
<script type="text/javascript" src="{{ static_url("js/shortcuts.min.js") }}"></script>
<script type="text/javascript">
	$(function(){
		$('.manager-menu, .health-sub').addClass('active');
		var o_comunities = $('.key').data('key'), o_key = $('.breadcrumb').data('key'),
			centros = ['Puesto de Salud','Centro de Salud','1er. Nivel','2do. Nivel','3er. Nivel'],
			options = [], o_prestaciones = JSON.stringify($('.key').data('prest')),
			tmpl = function(obj){
				return ''+
				'<div class="input-group">'+
					'<span class="input-group-addon">'+
						'<input type="checkbox" name="id_com" value="'+obj.id+'">'+
					'</span>'+
					'<label class="form-control input-sm">'+obj.nombre+'</label>'+
				'</div>';
			},
			prest = function(obj){
				return ''+
				'<div class="input-group">'+
					'<span class="input-group-addon">'+
						'<input type="checkbox" name="id_pst" value="'+obj.id_pst+'">'+
					'</span>'+
					'<label class="form-control input-sm">'+obj.nombre+'</label>'+
				'</div>';
			};
		//console.log('o_key',o_key);
		for (var i = 0; i < centros.length; i++) {
			if(centros[i]==o_key.tipo){
				options.push('<option value="'+centros[i]+'" selected>'+centros[i]+'</option>');
			} else{
				options.push('<option value="'+centros[i]+'">'+centros[i]+'</option>');
			}
		};
		$('#inputTipo').html(options.join(''));
		for (var i = 0; i < o_comunities.length; i++) {
			if(o_key.com!=o_comunities[i].id){
				$('#comunidades').append(tmpl(o_comunities[i]));
			}
		};
		$.post(
			'/prestaciones/disponibles',
			data = {'_xsrf':getCookie('_xsrf'), 'prestaciones': o_prestaciones},
			function(response){
				if($.type(response)=='array'){
					for (var i = 0; i < response.length; i++) {
						$('#prestaciones').append(prest(response[i]));
					};
				}
			}
		);
		$('.networks').on({
			click:function(e){
				e.preventDefault();
				location.href='/redes_salud/gestion';
			}
		});
		$('.net').on({
			click:function(e){
				e.preventDefault();
				location.href='/municipios/gestion?id_red='+o_key.red;
			}
		});
		$('.mup').on({
			click:function(e){
				e.preventDefault();
				location.href='/comunidades/gestion?id_mup='+o_key.mup
			}
		});
		$('.back').on({
			click:function(e){
				e.preventDefault();
				location.href='/centros_salud/gestion?id_com='+o_key.com;
			}
		});
	});
</script>
{% end %}
{% block breadcrumbs %}
<ul id="breadcrumbs" class="breadcrumb" data-key='{"red":{{cen.ubicado.municipio.red_salud.id_red}},"mup":{{cen.ubicado.municipio.id_mup}},"com":{{cen.ubicado.id_com}},"tipo":"{{cen.tipo}}"}'>
	<li><a href="/">Inicio</a></li>
	<li><a href="#" class="networks">Redes de Salud</a></li>
	<li><a href="#" class="net">Red: {{cen.ubicado.municipio.red_salud}}</a></li>
	<li><a href="#" class="mup">Municipio: {{cen.ubicado.municipio}}</a></li>
	<li><a href="#" class="back">Comunidad: {{cen.ubicado}}</a></li>
	<li class="active">Modificar Establecimiento de Salud</li>
</ul>
{% end %}
{% block left-content %}
<form action="/centros_salud/modificar_establecimiento" method="POST" class="key" data-key="{{dumps([dict(id=com.id_com,nombre=com.nombre) for com in cen.ubicado.municipio.comunidades if com.activo and com not in cen.comunidades])}}" data-prest="{{dumps([pr.id_pst for pr in cen.prestaciones])}}">
	{% module xsrf_form_html() %}
	<input type="hidden" name="id_cen" value="{{cen.id_cen}}" readonly>
	<div class="form-group">
		<legend>Modificar Establecimiento de {{cen.ubicado}}</legend>
	</div>
	<div class="row">
		<div class="form-group col-sm-6">
			<label for="inputTipo" >Tipo:</label>
			<select name="tipo" id="inputTipo" class="form-control input-sm" required></select>
		</div>
		<div class="form-group has-feedback col-sm-6">
			<label for="inputNombre">Nombre:</label>
			<input type="text" name="nombre" value="{{cen.nombre}}" id="inputNombre" class="form-control input-sm only_g_names" required>
			<span class="form-control-feedback"></span>
		</div>
	</div>
	<div id="comunidades">
		<div class="form-group">
			<legend>Asignar Comunidades para Atenci√≥n</legend>
		</div>
		{% for com in cen.comunidades %}
		{% if com.id_com != cen.ubicado.id_com %}
		<div class="input-group">
			<span class="input-group-addon">
				<input type="checkbox" name="id_com" value="{{com.id_com}}" checked>
			</span>
			<label class="form-control input-sm">{{com}}</label>
		</div>
		{% end %}
		{% end %}
	</div><br>
	<div id="prestaciones">
		<div class="form-group">
			<legend>Asignar Prestaciones al Establecimiento de Salud</legend>
		</div>
		{% for pr in cen.prestaciones %}
		<div class="input-group">
			<span class="input-group-addon">
				<input type="checkbox" name="id_pst" value="{{pr.id_pst}}" checked>
			</span>
			<label class="form-control input-sm">{{pr}}</label>
		</div>
		{% end %}
	</div><br>
	<div class="form-group">
		<button type="button" class="back btn btn-sm btn-warning">Regresar</button>
		<button type="submit" class="btn btn-sm btn-primary">Actualizar</button>
	</div>
</form>
{% end %}